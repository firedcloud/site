{
    "Error": {
        "RetryIn": null,
        "InnerErrors": [],
        "Code": "UnknownError",
        "Message": "Exception of type 'Microsoft.CCI.BotChannelRegistration.Exceptions.GraphExceptions.GraphBaseException' was thrown.",
        "Properties": {},
        "Diagnostics": "Microsoft.CCI.BotChannelRegistration.Exceptions.GraphExceptions.GraphBaseException: Exception of type 'Microsoft.CCI.BotChannelRegistration.Exceptions.GraphExceptions.GraphBaseException' was thrown.\r\n\r\n---> Status Code: Unauthorized\r\nMicrosoft.Graph.ServiceException: AdditionalData:\r\n\terror: {\r\n  \"code\": \"Authorization_IdentityNotFound\",\r\n  \"message\": \"The identity of the calling application could not be established.\",\r\n  \"innerError\": {\r\n    \"date\": \"2023-08-04T11:27:00\",\r\n    \"request-id\": \"1ecd922e-7376-476e-b56a-73a39ce9a2fb\",\r\n    \"client-request-id\": \"1ecd922e-7376-476e-b56a-73a39ce9a2fb\"\r\n  }\r\n}\r\n\r\n   at Microsoft.CCI.ManagedStore.Services.Graph.GraphHttpProvider.SendAsync(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationToken cancellationToken) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Services\\Graph\\GraphHttpProvider.cs:line 66\r\n   at Microsoft.Graph.BaseRequest.SendRequestAsync(Object serializableObject, CancellationToken cancellationToken, HttpCompletionOption completionOption)\r\n   at Microsoft.Graph.BaseRequest.SendAsync[T](Object serializableObject, CancellationToken cancellationToken, HttpCompletionOption completionOption)\r\n   at Microsoft.Graph.GraphServiceSubscribedSkusCollectionRequest.GetAsync(CancellationToken cancellationToken)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync[TResult](ILogger logger, EventId eventId, ActivityType activityType, Func`1 action, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync[TResult](ILogger logger, ActivityType activityType, Func`1 func, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync[TResult](ILogger logger, String activityName, Func`1 func, IEnumerable`1 additionalCustomProperties)\r\n   at Polly.AsyncPolicy.ExecuteAsync[TResult](Func`3 action, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext)\r\n   at Polly.Wrap.AsyncPolicyWrapEngine.<>c__DisplayClass1_0`1.<<ImplementationAsync>b__0>d.MoveNext()\r\n--- End of stack trace from previous location ---\r\n   at Polly.Retry.AsyncRetryEngine.ImplementationAsync[TResult](Func`3 action, Context context, CancellationToken cancellationToken, ExceptionPredicates shouldRetryExceptionPredicates, ResultPredicates`1 shouldRetryResultPredicates, Func`5 onRetryAsync, Int32 permittedRetryCount, IEnumerable`1 sleepDurationsEnumerable, Func`4 sleepDurationProvider, Boolean continueOnCapturedContext)\r\n   at Polly.AsyncPolicy`1.ExecuteAsync(Func`3 action, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext)\r\n   at Polly.Wrap.AsyncPolicyWrapEngine.ImplementationAsync[TResult](Func`3 func, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext, IAsyncPolicy`1 outerPolicy, IAsyncPolicy innerPolicy)\r\n   at Polly.AsyncPolicy`1.ExecuteAsync(Func`3 action, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext)\r\n   at Polly.Wrap.AsyncPolicyWrapEngine.<>c__DisplayClass2_0`1.<<ImplementationAsync>b__0>d.MoveNext()\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync[TResult](ILogger logger, EventId eventId, ActivityType activityType, Func`1 action, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync[TResult](ILogger logger, ActivityType activityType, Func`1 func, IEnumerable`1 additionalCustomProperties)\r\n   at Polly.AsyncPolicy.ExecuteAsync[TResult](Func`3 action, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext)\r\n   at Polly.Wrap.AsyncPolicyWrapEngine.ImplementationAsync[TResult](Func`3 func, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext, IAsyncPolicy outerPolicy, IAsyncPolicy`1 innerPolicy)\r\n   at Polly.AsyncPolicy`1.ExecuteAsync(Func`3 action, Context context, CancellationToken cancellationToken, Boolean continueOnCapturedContext)\r\n   at Microsoft.CCI.ManagedStore.Services.Graph.ServicePrincipalProvisioningService.ProvisionAsync(IGraphServiceClient graphClient, Guid tenantId, CancellationToken ct) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Services\\Graph\\ServicePrincipalProvisioningService.cs:line 58\r\n<--- End Inner Exception\r\n   at Microsoft.CCI.ManagedStore.Services.Graph.ServicePrincipalProvisioningService.ProvisionAsync(IGraphServiceClient graphClient, Guid tenantId, CancellationToken ct) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Services\\Graph\\ServicePrincipalProvisioningService.cs:line 62\r\n   at Microsoft.CCI.ManagedStore.Services.Graph.ServicePrincipalProvisioningService.ProvisionAsync(Guid tenantId, CancellationToken ct) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Services\\Graph\\ServicePrincipalProvisioningService.cs:line 48\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync(ILogger logger, EventId eventId, ActivityType activityType, Func`1 action, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync(ILogger logger, ActivityType activityType, Func`1 action, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.PowerApps.CoreFramework.ActivityLoggerExtensions.ExecuteAsync(ILogger logger, String activityName, Func`1 action, IEnumerable`1 additionalCustomProperties)\r\n   at Microsoft.CCI.ManagedStore.Stores.GeoLocator.GetTenantGeoAsync(Guid tenantId, String graphAccessToken, CancellationToken ct) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Stores\\Geo\\GeoLocator.cs:line 99\r\n   at Microsoft.CCI.ManagedStore.Stores.RegistrationStore.RegisterTenantAsync(String aadTenantId, String graphAccessToken, CancellationToken ct) in C:\\__w\\1\\s\\src\\ManagedStore\\Microsoft.CCI.ManagedStore\\Stores\\Geo\\RegistrationStore.cs:line 83\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Authorization.RegistrationRequirementHandler.<>c__DisplayClass5_0.<<HandleRequirementAsync>b__1>d.MoveNext() in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Authorization\\RegistrationRequirementHandler.cs:line 80\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.<>c__DisplayClass26_0.<<RunAsync>b__0>d.MoveNext() in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 456\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.<>c__DisplayClass28_0.<<RunAsync>b__0>d.MoveNext() in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 503\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.RunAsync[T](Func`1 action, Func`2 exceptionHandler, Int32 maximumRetries, Func`2 sleepBetweenRetriesGetter) in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 558\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.RunAsync[T](Func`1 action, Func`2 exceptionHandler, Int32 maximumRetries, Func`2 sleepBetweenRetriesGetter) in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 571\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.RunAsync(Func`1 action, Func`2 exceptionHandler, Int32 maximumRetries, Func`2 sleepBetweenRetriesGetter) in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 507\r\n   at Microsoft.CCI.Common.ExecuteWithRetry.RunAsync(Func`1 action, Func`2 exceptionHandler, Int32 maximumRetries, TimeSpan sleepBetweenRetries) in C:\\__w\\1\\s\\src\\Infrastructure\\Common\\Microsoft.CCI.Common\\ExecuteWithRetry.cs:line 460\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Authorization.RegistrationRequirementHandler.HandleRequirementAsync(AuthorizationHandlerContext context, RegistrationRequirement requirement) in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Authorization\\RegistrationRequirementHandler.cs:line 124\r\n   at Microsoft.AspNetCore.Authorization.AuthorizationHandler`1.HandleAsync(AuthorizationHandlerContext context)\r\n   at Microsoft.AspNetCore.Authorization.DefaultAuthorizationService.AuthorizeAsync(ClaimsPrincipal user, Object resource, IEnumerable`1 requirements)\r\n   at Microsoft.AspNetCore.Authorization.Policy.PolicyEvaluator.AuthorizeAsync(AuthorizationPolicy policy, AuthenticateResult authenticationResult, HttpContext context, Object resource)\r\n   at Microsoft.AspNetCore.Mvc.Authorization.AuthorizeFilter.OnAuthorizationAsync(AuthorizationFilterContext context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Builder.RouterMiddleware.Invoke(HttpContext httpContext)\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Middleware.LocalizationMiddleware.InvokeAsync(HttpContext context) in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Middleware\\LocalizationMiddleware.cs:line 40\r\n   at Microsoft.AspNetCore.Localization.RequestLocalizationMiddleware.Invoke(HttpContext context)\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Middleware.LoggerPropertiesMiddleware.InvokeAsync(HttpContext httpContext) in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Middleware\\LoggerPropertiesMiddleware.cs:line 59\r\n   at Microsoft.Identity.ServiceEssentials.Extensions.AspNetCoreMiddleware.MiseMiddleware.InvokeInternal(HttpContext context)\r\n   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Middleware.SecurityHeaderMiddleware.InvokeAsync(HttpContext context) in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Middleware\\SecurityHeaderMiddleware.cs:line 28\r\n   at Microsoft.CCI.BotManagement.Middleware.Common.Extensions.ErrorHandlingExtensions.<>c__DisplayClass2_0.<<RunWithPureCDSErrorHandling>b__0>d.MoveNext() in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Extensions\\ErrorHandlingExtensions.cs:line 74\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.CCI.BotManagement.Middleware.Common.Extensions.ErrorHandlingExtensions.<>c__DisplayClass4_0`1.<<RunWithPureCDSErrorHandling>b__0>d.MoveNext() in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Extensions\\ErrorHandlingExtensions.cs:line 204\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.CCI.BotManagement.Middleware.Implementation.Middleware.GlobalIncomingRequestMiddleware.<>c__DisplayClass18_0.<<InvokeAsync>b__0>d.MoveNext() in C:\\__w\\1\\s\\src\\Microsoft.CCI.BotManagement.Middleware\\Microsoft.CCI.BotManagement.Middleware\\Implementation\\Middleware\\GlobalIncomingRequestMiddleware.cs:line 139"
    }
}